<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Player Drawing App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none; /* Prevents scrolling on touch devices when drawing */
        }
        canvas {
            border: 2px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            cursor: crosshair;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-4xl p-4 bg-white rounded-xl shadow-lg text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Collaborative Drawing Board</h1>
        <p id="userIdDisplay" class="text-sm text-gray-500 mb-4">Connecting to the canvas...</p>
        
        <canvas id="drawingCanvas"></canvas>

        <div class="mt-4 flex flex-wrap items-center justify-center gap-4">
            <div class="flex items-center gap-2">
                <label for="colorPicker" class="text-gray-700 font-medium">Color:</label>
                <input type="color" id="colorPicker" value="#000000" class="w-10 h-10 p-1 border-gray-300 rounded-md cursor-pointer">
            </div>
            <div class="flex items-center gap-2">
                <label for="brushSize" class="text-gray-700 font-medium">Size:</label>
                <input type="range" id="brushSize" min="1" max="50" value="5" class="w-36 cursor-pointer">
            </div>
            <button id="clearCanvas" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75">
                Clear Canvas
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /******************************************************************************
         * START OF OUR APPLICATION CODE
         ******************************************************************************/

        // --- DOM Elements ---
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('colorPicker');
        const brushSize = document.getElementById('brushSize');
        const clearButton = document.getElementById('clearCanvas');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // --- App State ---
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentColor = '#000000';
        let currentSize = 5;
        let isClearing = false;

        // --- Firebase Config ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // [FIX] User's Firebase configuration has been added.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB3SIrzA5Y3nZhjZXvzKiW3irJubfNdD7g",
            authDomain: "live-stocks-etfs-mutual-funds.firebaseapp.com",
            projectId: "live-stocks-etfs-mutual-funds",
            storageBucket: "live-stocks-etfs-mutual-funds.firebasestorage.app",
            messagingSenderId: "148439147431",
            appId: "1:148439147431:web:06d34e54a4e12af7cd8c82"
        };
        
        let db;
        
        // --- Drawing Functions ---

        /**
         * Resizes the canvas to fit its container while maintaining drawing content.
         */
        function resizeCanvas() {
            let imageData;
            if (canvas.width > 0 && canvas.height > 0) {
                imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth;
            canvas.height = window.innerHeight * 0.6;

            if (imageData) {
                ctx.putImageData(imageData, 0, 0);
            }
        }

        /**
         * Draws a line segment on the canvas.
         */
        function drawLine(x1, y1, x2, y2, color, size) {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = size;
            ctx.lineCap = 'round';
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
        }
        
        /**
         * Clears the entire canvas.
         */
        function clearLocalCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        /**
         * Deletes all drawing data from Firestore for a persistent clear.
         */
        async function clearFirestoreDrawing() {
            if (isClearing) return;
            isClearing = true;
            clearButton.disabled = true;
            clearButton.textContent = 'Clearing...';

            try {
                const pointsCollection = collection(db, `/artifacts/${appId}/public/data/drawing_points`);
                const pointsSnapshot = await getDocs(pointsCollection);
                const batch = writeBatch(db);
                pointsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                 addDoc(collection(db, `/artifacts/${appId}/public/data/drawing_controls`), {
                    action: 'clear',
                    timestamp: Date.now()
                });

            } catch (error) {
                console.error("Error clearing Firestore drawing:", error);
            } finally {
                isClearing = false;
                clearButton.disabled = false;
                clearButton.textContent = 'Clear Canvas';
            }
        }

        // --- Event Handlers ---
        
        function handleDrawStart(e) {
            e.preventDefault();
            isDrawing = true;
            [lastX, lastY] = getCoords(e);
        }
        
        function handleDrawMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const [x, y] = getCoords(e);
            
            drawLine(lastX, lastY, x, y, currentColor, currentSize);
            
            const pointsCollection = collection(db, `/artifacts/${appId}/public/data/drawing_points`);
            addDoc(pointsCollection, {
                x1: lastX, y1: lastY, x2: x, y2: y,
                color: currentColor, size: currentSize,
                timestamp: Date.now()
            });

            [lastX, lastY] = [x, y];
        }

        function handleDrawEnd(e) {
            e.preventDefault();
            isDrawing = false;
        }

        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
            }
            return [e.clientX - rect.left, e.clientY - rect.top];
        }

        /**
         * Sets up canvas event listeners and Firestore subscriptions.
         */
        function initCanvas() {
            canvas.addEventListener('mousedown', handleDrawStart);
            canvas.addEventListener('mousemove', handleDrawMove);
            canvas.addEventListener('mouseup', handleDrawEnd);
            canvas.addEventListener('mouseout', handleDrawEnd);
            canvas.addEventListener('touchstart', handleDrawStart);
            canvas.addEventListener('touchmove', handleDrawMove);
            canvas.addEventListener('touchend', handleDrawEnd);
            
            colorPicker.addEventListener('change', (e) => currentColor = e.target.value);
            brushSize.addEventListener('input', (e) => currentSize = e.target.value);
            clearButton.addEventListener('click', clearFirestoreDrawing);

            const pointsCollection = collection(db, `/artifacts/${appId}/public/data/drawing_points`);
            const qPoints = query(pointsCollection);
            onSnapshot(qPoints, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        drawLine(data.x1, data.y1, data.x2, data.y2, data.color, data.size);
                    }
                });
            });

            const controlsCollection = collection(db, `/artifacts/${appId}/public/data/drawing_controls`);
            const qControls = query(controlsCollection);
            onSnapshot(qControls, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        if (data.action === 'clear') {
                            clearLocalCanvas();
                        }
                    }
                });
            });
        }

        /**
         * Main function to initialize the app.
         */
        async function main() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userIdDisplay.textContent = `Your User ID: ${user.uid}`;
                        if (!canvas.dataset.initialized) {
                            initCanvas();
                            canvas.dataset.initialized = "true";
                        }
                    } else {
                         userIdDisplay.textContent = "Authenticating...";
                    }
                });
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                userIdDisplay.textContent = "Authentication failed. Please refresh.";
            }
        }

        // --- App Entry Point ---
        window.addEventListener('load', () => {
            resizeCanvas();
            main();
        });
        window.addEventListener('resize', resizeCanvas);
    </script>
</body>
</html>

